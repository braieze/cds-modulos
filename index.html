<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Conquistadores App</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { brand: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 900:'#1e3a8a' }, surface: '#f8fafc' },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0,0,0,0.05)', 'glow': '0 0 15px rgba(37,99,235,0.3)', 'input': '0 2px 5px rgba(0,0,0,0.03)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f1f5f9; -webkit-font-smoothing: antialiased; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .animate-enter { animation: enter 0.3s ease-out; }
        @keyframes enter { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .input-modern { @apply w-full bg-white border border-slate-300 text-slate-900 font-medium rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 outline-none; }
        .label-modern { @apply block text-xs font-bold text-slate-900 uppercase tracking-wide mb-1.5 ml-1; }
    </style>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDXK_EcXsFGhRmXfkKG8SMdsM69c4PNfHw", authDomain: "conquistadoresapp.firebaseapp.com", projectId: "conquistadoresapp", storageBucket: "conquistadoresapp.firebasestorage.app", messagingSenderId: "518647225464", appId: "1:518647225464:web:b3344ca5172498187e218d" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        window.googleProvider = new firebase.auth.GoogleAuthProvider();
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    </script>

    <script type="text/babel" src="src/Utils.js"></script>
    <script type="text/babel" src="src/DataLogic.js"></script>
    <script type="text/babel" src="src/views/GlobalCalendar.js"></script>
    <script type="text/babel" src="src/views/EventDetails.js"></script>
    <script type="text/babel" src="src/views/Dashboard.js"></script>
    <script type="text/babel" src="src/views/Directory.js"></script>
    <script type="text/babel" src="src/views/Finances.js"></script>
    <script type="text/babel" src="src/views/Worship.js"></script>
    <script type="text/babel" src="src/views/MinistryWithTasks.js"></script>
    <script type="text/babel" src="src/views/Messaging.js"></script>
    <script type="text/babel" src="src/views/Blog.js"></script>
    <script type="text/babel" src="src/views/QuickActions.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Icon, ToastContainer } = window.Utils || {};
        const { useFirebaseListeners, addData, updateData, deleteData } = window.DataLogic || {};
        const Views = window.Views || {};
        const { Dashboard, Directory, Finances, Worship, MinistryWithTasks, GlobalCalendar, Messaging, Blog, QuickActions } = Views;

        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                <div className="bg-white p-8 rounded-3xl shadow-soft max-w-sm w-full text-center">
                    <div className="bg-brand-600 w-16 h-16 rounded-2xl mx-auto flex items-center justify-center text-white mb-6 shadow-glow"><Icon name="Home" size={32}/></div>
                    <h1 className="text-2xl font-extrabold text-slate-800">Conquistadores</h1>
                    <button onClick={onLogin} className="w-full bg-brand-600 text-white py-3.5 rounded-xl font-bold shadow-lg mt-6">Ingresar con Google</button>
                </div>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [data, setData] = useState({ members:[], finances:[], worship:[], songs:[], ebd:[], youth:[], tasks:[], servers:[], messages:[], posts:[] });

            // Setters individuales para compatibilidad
            const setters = {
                members: v=>setData(p=>({...p, members:v})), finances: v=>setData(p=>({...p, finances:v})), worship: v=>setData(p=>({...p, worship:v})),
                songs: v=>setData(p=>({...p, songs:v})), ebd: v=>setData(p=>({...p, ebd:v})), youth: v=>setData(p=>({...p, youth:v})),
                tasks: v=>setData(p=>({...p, tasks:v})), servers: v=>setData(p=>({...p, servers:v})), messages: v=>setData(p=>({...p, messages:v})), posts: v=>setData(p=>({...p, posts:v}))
            };

            useEffect(() => {
                window.auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        const q = await window.db.collection('members').where('email', '==', u.email).get();
                        if (!q.empty) setProfile({ ...q.docs[0].data(), id: q.docs[0].id });
                        else {
                             // Auto-crear admin
                             const adm = { name: u.displayName, email: u.email, role: 'Pastor', ministry: 'General', photo: u.photoURL, status: 'Activo' };
                             await window.db.collection('members').add(adm); setProfile(adm);
                        }
                    } else { setUser(null); setProfile(null); }
                    setLoading(false);
                });
            }, []);

            useFirebaseListeners(profile, setters);

            const login = () => window.auth.signInWithPopup(window.googleProvider);
            const logout = () => window.auth.signOut();

            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400 font-bold animate-pulse">Cargando...</div>;
            if (!user || !profile) return <LoginScreen onLogin={login} />;

            const NavItem = ({ id, label, icon }) => (
                <button onClick={() => { setActiveTab(id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all mb-1 ${activeTab === id ? 'bg-brand-50 text-brand-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}>
                    {Icon && <Icon name={icon} />} {label}
                </button>
            );

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden font-sans text-slate-900">
                    {ToastContainer && <ToastContainer />}
                    <aside className={`fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-100 transition-transform duration-300 md:relative md:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 flex flex-col h-full">
                            <div className="flex items-center gap-3 mb-8"><div className="bg-brand-600 text-white p-2 rounded-xl shadow-glow">{Icon && <Icon name="Home"/>}</div><span className="font-extrabold text-xl tracking-tight">Conquistadores</span></div>
                            <nav className="flex-1 overflow-y-auto hide-scroll space-y-1">
                                <NavItem id="dashboard" icon="Home" label="Inicio" />
                                <NavItem id="calendar" icon="Calendar" label="Calendario" />
                                <NavItem id="blog" icon="Book" label="Devocionales" />
                                <div className="mt-6 mb-2 px-4 text-xs font-bold text-slate-400 uppercase tracking-widest">Ministerios</div>
                                <NavItem id="worship" icon="Music" label="Alabanza" />
                                <NavItem id="servers" icon="Hand" label="Servidores" />
                                <NavItem id="ebd" icon="BookOpen" label="Escuela Bíblica" />
                                <NavItem id="youth" icon="Smile" label="Jóvenes" />
                                <div className="mt-6 mb-2 px-4 text-xs font-bold text-slate-400 uppercase tracking-widest">Gestión</div>
                                {profile.role === 'Pastor' && <NavItem id="finances" icon="Wallet" label="Tesorería" />}
                                <NavItem id="members" icon="Users" label="Directorio" />
                                <NavItem id="messages" icon="Mail" label="Mensajería" />
                            </nav>
                            <div className="mt-auto pt-6 border-t flex justify-between items-center"><div className="flex gap-3 items-center"><img src={profile.photo} className="w-9 h-9 rounded-full bg-slate-200"/><div className="leading-tight"><p className="font-bold text-xs truncate w-24">{profile.name}</p><p className="text-[9px] uppercase font-bold text-slate-500">{profile.role}</p></div></div><button onClick={logout} className="text-red-500"><Icon name="LogOut"/></button></div>
                        </div>
                    </aside>
                    <main className="flex-1 flex flex-col h-screen overflow-hidden relative w-full">
                        <header className="md:hidden bg-white/80 backdrop-blur p-4 border-b flex justify-between items-center z-20"><span className="font-bold text-lg">Conquistadores</span><button onClick={()=>setSidebarOpen(true)}>{Icon && <Icon name="Menu"/>}</button></header>
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 pb-24">
                            <div className="max-w-6xl mx-auto">
                                {activeTab==='dashboard' && Dashboard && <Dashboard userProfile={profile} {...data} updateData={updateData} setActiveTab={setActiveTab} />}
                                {activeTab==='finances' && Finances && <Finances finances={data.finances} addData={addData} userProfile={profile} />}
                                {activeTab==='worship' && Worship && <Worship worship={data.worship} songs={data.songs} members={data.members} addData={addData} updateData={updateData} deleteData={deleteData} />}
                                {activeTab==='ebd' && MinistryWithTasks && <MinistryWithTasks title="Escuela Bíblica" col="ebd" filterMinistry="EBD" members={data.members} tasks={data.tasks} events={data.ebd} addData={addData} deleteData={deleteData} updateData={updateData} />}
                                {activeTab==='youth' && MinistryWithTasks && <MinistryWithTasks title="Jóvenes" col="youth" filterMinistry="Jóvenes" members={data.members} tasks={data.tasks} events={data.youth} addData={addData} deleteData={deleteData} updateData={updateData} />}
                                {activeTab==='servers' && MinistryWithTasks && <MinistryWithTasks title="Cuerpo de Servidores" col="servers" filterMinistry="Servidores" members={data.members} tasks={data.tasks} events={data.servers} addData={addData} deleteData={deleteData} updateData={updateData} />}
                                {activeTab==='calendar' && GlobalCalendar && <GlobalCalendar {...data} userProfile={profile} addData={addData} />}
                                {activeTab==='messages' && Messaging && <Messaging messages={data.messages} members={data.members} userProfile={profile} addData={addData} updateData={updateData} deleteData={deleteData} />}
                                {activeTab==='blog' && Blog && <Blog userProfile={profile} addData={addData} deleteData={deleteData} updateData={updateData} />}
                                {activeTab==='members' && Directory && <Directory members={data.members} addData={addData} updateData={updateData} deleteData={deleteData} />}
                            </div>
                        </div>
                    </main>
                    {QuickActions && <QuickActions userProfile={profile} setActiveTab={setActiveTab} />}
                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setSidebarOpen(false)}></div>}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
