<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conquistadores App - Gestión Real</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { colors: { brand: { 50:'#fff7ed', 100:'#ffedd5', 500:'#f97316', 600:'#ea580c', 700:'#c2410c', 900:'#7c2d12' } }, fontFamily: { sans: ['Inter', 'sans-serif'] } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .input-modern { @apply w-full border border-slate-200 bg-slate-50 p-2.5 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all; }
        .label-modern { @apply block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5; }
    </style>

    <script type="text/babel" src="src/Utils.js"></script>
    <script type="text/babel" src="src/DataLogic.js"></script>
    
    <script type="text/babel" src="src/views/GlobalCalendar.js"></script>
    <script type="text/babel" src="src/views/Dashboard.js"></script>
    <script type="text/babel" src="src/views/Directory.js"></script>
    <script type="text/babel" src="src/views/Finances.js"></script>
    <script type="text/babel" src="src/views/Worship.js"></script>
    <script type="text/babel" src="src/views/MinistryWithTasks.js"></script>
    <script type="text/babel" src="src/views/Messaging.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- YA NO CONFIGURAMOS FIREBASE AQUÍ ---
        // La configuración ahora ocurre automáticamente al importar src/DataLogic.js

        const { useState, useEffect } = React;
        const db = firebase.firestore(); // Podemos llamarlo porque DataLogic ya lo inicializó

        // Importar desde el objeto global
        const { Icon, Card, Button } = window.Utils;
        
        // Importar Auth y Logica desde DataLogic
        const { useFirebaseListeners, addData, updateData, deleteData, auth, googleProvider } = window.DataLogic;
        
        // Importar Vistas
        const { Dashboard, Directory, Finances, Worship, MinistryWithTasks, GlobalCalendar, Messaging } = window.Views;

        // Login Component
        const LoginScreen = ({ onLogin, loading, error }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                <Card className="max-w-md w-full text-center space-y-8 py-12">
                    <div className="bg-brand-100 w-20 h-20 rounded-3xl mx-auto flex items-center justify-center text-brand-600 mb-6"><Icon name="Home" size={40}/></div>
                    <div><h1 className="text-3xl font-extrabold text-slate-800">Conquistadores App</h1><p className="text-slate-500 mt-2">Plataforma de Gestión Integral</p></div>
                    {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">{error}</div>}
                    <Button onClick={onLogin} className="w-full justify-center py-4 text-lg" disabled={loading}>{loading ? 'Conectando...' : 'Iniciar Sesión con Google'}</Button>
                </Card>
            </div>
        );

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [authError, setAuthError] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);

            // Estado de Datos
            const [members, setMembers] = useState([]);
            const [finances, setFinances] = useState([]);
            const [worship, setWorship] = useState([]);
            const [songs, setSongs] = useState([]);
            const [ebd, setEbd] = useState([]);
            const [youth, setYouth] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [servers, setServers] = useState([]);
            const [messages, setMessages] = useState([]);

            // Autenticación
            useEffect(() => {
                // Usamos 'auth' que viene de window.DataLogic
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        setCurrentUser(user);
                        const q = db.collection('members').where('email', '==', user.email);
                        const snapshot = await q.get();
                        if (!snapshot.empty) {
                            setUserProfile({ ...snapshot.docs[0].data(), id: snapshot.docs[0].id });
                        } else {
                            const checkEmpty = await db.collection('members').get();
                            if(checkEmpty.empty) {
                                const newAdmin = { name: user.displayName, email: user.email, role: 'Pastor', ministry: 'Pastoral', photo: user.photoURL, status: 'Activo' };
                                await db.collection('members').add(newAdmin);
                                setUserProfile(newAdmin);
                            } else {
                                setUserProfile(null); setAuthError("Tu email no está registrado.");
                            }
                        }
                    } else { setCurrentUser(null); setUserProfile(null); }
                    setLoadingAuth(false);
                });
                return () => unsubscribe();
            }, []);

            // Cargar Datos (usando el Hook de DataLogic)
            useFirebaseListeners(userProfile, {
                members: setMembers, finances: setFinances, worship: setWorship, songs: setSongs,
                ebd: setEbd, youth: setYouth, tasks: setTasks, servers: setServers, messages: setMessages
            });

            const handleLogin = async () => { try { await auth.signInWithPopup(googleProvider); } catch(e) { setAuthError("Error Google"); } };
            const handleLogout = () => auth.signOut();

            if (loadingAuth) return <div className="min-h-screen flex items-center justify-center text-slate-500">Cargando sistema...</div>;
            if (!currentUser || !userProfile) return <LoginScreen onLogin={handleLogin} loading={loadingAuth} error={authError} />;

            const NavItem = ({ id, label, icon }) => (
                <button onClick={() => { setActiveTab(id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all mb-1 ${activeTab === id ? 'bg-brand-600 text-white shadow-lg' : 'text-brand-100/70 hover:bg-brand-800 hover:text-white'}`}>
                    <Icon name={icon} /> {label}
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className={`fixed md:relative z-40 w-72 bg-brand-900 text-white h-full flex flex-col transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-8"><div className="bg-white/10 p-2 rounded-lg"><Icon name="Home" /></div><span className="font-bold text-lg">Conquistadores</span></div>
                            <nav className="space-y-1">
                                <NavItem id="dashboard" icon="Home" label="Inicio" />
                                <NavItem id="directory" icon="Users" label="Directorio" />
                                <NavItem id="calendar" icon="Calendar" label="Calendario" />
                                <div className="mt-6 mb-2 px-4 text-xs font-bold text-brand-500/60 uppercase tracking-widest">Ministerios</div>
                                {(userProfile.role === 'Pastor' || userProfile.ministry === 'Alabanza') && <NavItem id="worship" icon="Music" label="Alabanza" />}
                                {(userProfile.role === 'Pastor' || userProfile.ministry === 'Servidores' || userProfile.ministry === 'General') && <NavItem id="servers" icon="Hand" label="Servidores" />}
                                {(userProfile.role === 'Pastor' || userProfile.ministry === 'EBD') && <NavItem id="ebd" icon="Book" label="Escuela Bíblica" />}
                                {(userProfile.role === 'Pastor' || userProfile.ministry === 'Jóvenes') && <NavItem id="youth" icon="Smile" label="Jóvenes" />}
                                <div className="mt-6 mb-2 px-4 text-xs font-bold text-brand-500/60 uppercase tracking-widest">Gestión</div>
                                {userProfile.role === 'Pastor' && <NavItem id="finances" icon="Wallet" label="Tesorería" />}
                                <NavItem id="messages" icon="Mail" label="Mensajería" />
                            </nav>
                        </div>
                        <div className="mt-auto p-6 bg-brand-950 flex items-center justify-between">
                            <div className="flex items-center gap-3 overflow-hidden">
                                {userProfile.photo && <img src={userProfile.photo} className="w-8 h-8 rounded-full"/>}
                                <div className="truncate"><p className="font-bold text-sm truncate">{userProfile.name}</p><p className="text-[10px] text-brand-400 uppercase">{userProfile.role}</p></div>
                            </div>
                            <button onClick={handleLogout}><Icon name="LogOut" className="text-brand-400 hover:text-white"/></button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto bg-slate-50 w-full relative">
                        <header className="md:hidden bg-white p-4 sticky top-0 z-30 shadow-sm flex justify-between items-center">
                            <span className="font-bold text-brand-900">App</span>
                            <button onClick={() => setSidebarOpen(true)} className="text-slate-600"><Icon name="Menu" /></button>
                        </header>
                        <div className="p-4 md:p-8 max-w-7xl mx-auto pb-24 h-full">
                            {activeTab === 'dashboard' && <Dashboard userProfile={userProfile} worship={worship} servers={servers} tasks={tasks} messages={messages} updateData={updateData} setActiveTab={setActiveTab} />}
                            {activeTab === 'directory' && <Directory members={members} addData={addData} updateData={updateData} />}
                            {activeTab === 'worship' && <Worship worship={worship} songs={songs} members={members} addData={addData} updateData={updateData} deleteData={deleteData} />}
                            {activeTab === 'finances' && <Finances finances={finances} addData={addData} />}
                            {activeTab === 'ebd' && <MinistryWithTasks title="Escuela Bíblica" col="ebd" filterMinistry="EBD" members={members} tasks={tasks} events={ebd} addData={addData} deleteData={deleteData} />}
                            {activeTab === 'youth' && <MinistryWithTasks title="Jóvenes" col="youth" filterMinistry="Jóvenes" members={members} tasks={tasks} events={youth} addData={addData} deleteData={deleteData} />}
                            
                            {/* CALENDARIO */}
                            {activeTab === 'calendar' && (
                                <GlobalCalendar worship={worship} youth={youth} ebd={ebd} servers={servers} tasks={tasks} />
                            )}
                            
                            {/* MENSAJERÍA */}
                            {activeTab === 'messages' && (
                                <Messaging messages={messages} members={members} userProfile={userProfile} addData={addData} updateData={updateData} />
                            )}
                        </div>
                    </main>
                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setSidebarOpen(false)}></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
